<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadio Interactivo - Canvas 2D</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            overflow: hidden;
        }

        #estadio-canvas {
            display: block;
            cursor: grab;
            touch-action: none;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 35, 126, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            transition: opacity 0.3s ease;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
            z-index: 100;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        #info-panel h3 {
            color: #1a237e;
            margin-top: 0;
            font-size: 1.4rem;
            border-bottom: 3px solid #ffd700;
            padding-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #1a237e;
            font-weight: 700;
        }

        #legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        #legend h4 {
            margin: 0 0 10px 0;
            color: #1a237e;
            font-size: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            min-width: 200px;
        }

        #controls h4 {
            margin: 0 0 12px 0;
            color: #1a237e;
            font-size: 1rem;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 8px;
        }

        #controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a237e;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .zoom-controls button {
            flex: 1;
            padding: 8px;
            font-size: 1.2rem;
        }

        .controls-help {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.75rem;
            color: #666;
        }

        .controls-help div {
            margin: 5px 0;
        }

        #asiento-info {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border-left: 4px solid #ffd700;
        }

        #asiento-info h4 {
            margin: 0 0 10px 0;
            color: #1a237e;
        }

        .asiento-detail {
            margin: 5px 0;
            color: #333;
        }

        #confirmar-btn {
            display: none;
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            border: none;
            border-radius: 40px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a237e;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #confirmar-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(255, 215, 0, 0.4);
        }

        #tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 200;
            display: none;
            white-space: nowrap;
        }

        .btn-link {
            display: block;
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            color: #1a237e;
            text-decoration: none;
            border: 2px solid #1a237e;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-link:hover {
            background: #1a237e;
            color: white;
        }

        @media (max-width: 768px) {
            #info-panel {
                width: calc(100% - 40px);
                top: auto;
                bottom: 20px;
                max-height: 40vh;
            }

            #legend {
                bottom: auto;
                top: 140px;
                left: 20px;
            }

            #controls {
                top: 20px;
                left: 20px;
                right: auto;
            }
        }
    </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading">
    <div class="spinner"></div>
    <h3>Cargando Estadio...</h3>
    <p>Inicializando vista (0%)</p>
</div>

<!-- Canvas Principal -->
<canvas id="estadio-canvas"></canvas>

<!-- Tooltip -->
<div id="tooltip"></div>

<!-- Panel de Informaci√≥n -->
<div id="info-panel">
    <h3>Estadio Johan Cruyff</h3>

    <!-- Recarga de Saldo -->
    <div style="background: linear-gradient(135deg, #fff9c4, #fff59d); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #ffd700;">
        <h5 style="color: #1a237e; margin: 0 0 10px 0; font-size: 0.95rem;">
            <i class="fas fa-wallet" style="margin-right: 5px;"></i>Recargar Saldo
        </h5>
        <form id="form-agregar-saldo" style="margin: 0;">
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="number" id="input-cantidad-saldo" name="cantidad" step="0.01" min="1" max="1000"
                    placeholder="Cantidad" required
                    style="flex: 1; padding: 8px; border: 2px solid #1a237e; border-radius: 8px; font-size: 0.9rem;">
                <button type="submit" id="btn-agregar-saldo" style="
                    background: linear-gradient(135deg, #1a237e, #283593);
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 8px;
                    font-weight: 700;
                    cursor: pointer;
                    white-space: nowrap;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <i class="fas fa-plus"></i> A√±adir
                </button>
            </div>
            <small style="display: block; margin-top: 5px; color: #666; font-size: 0.75rem;">Entre 1‚Ç¨ y 1000‚Ç¨</small>
            <div id="mensaje-saldo" style="margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 0.85rem; display: none;"></div>
        </form>
    </div>

    <div id="zona-info">
        <p style="text-align: center; color: #666;">Cargando informaci√≥n...</p>
    </div>

    <div id="asiento-info"></div>

    <button id="confirmar-btn" onclick="confirmarCompra()">
        <i class="fas fa-check me-2"></i>Confirmar Compra
    </button>

    <a href="/eventos" class="btn-link">
        <i class="fas fa-arrow-left me-2"></i>Volver a Eventos
    </a>
</div>

<!-- Leyenda -->
<div id="legend">
    <h4><i class="fas fa-info-circle me-2"></i>Leyenda</h4>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #4CAF50;"></div>
        <span>Disponible</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #f44336;"></div>
        <span>Ocupado</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #2196F3;"></div>
        <span>Seleccionado</span>
    </div>
    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0; font-size: 0.85rem; color: #666;">
        <i class="fas fa-lightbulb" style="color: #ffd700; margin-right: 5px;"></i>
        <strong>Tip:</strong> Click para seleccionar/deseleccionar (m√°x. 10)
    </div>
</div>

<!-- Controles -->
<div id="controls">
    <h4><i class="fas fa-cog me-2"></i>Controles</h4>

    <!-- Zoom -->
    <div class="zoom-controls">
        <button onclick="ajustarZoom(-0.2)" title="Alejar">
            <i class="fas fa-search-minus"></i>
        </button>
        <button onclick="ajustarZoom(0.2)" title="Acercar">
            <i class="fas fa-search-plus"></i>
        </button>
    </div>

    <!-- Resetear Vista -->
    <button onclick="resetearVista()">
        <i class="fas fa-undo me-2"></i>Resetear Vista
    </button>

    <!-- Ayuda -->
    <div class="controls-help">
        <div><i class="fas fa-hand-pointer"></i> Arrastra para mover</div>
        <div><i class="fas fa-scroll"></i> Scroll para zoom</div>
        <div><i class="fas fa-mouse"></i> Click para seleccionar</div>
    </div>
</div>

<!-- Scripts -->
<script>
    // ID del evento (cambiar con Thymeleaf en producci√≥n)
    const eventoId = 1; // /*[[${evento.id}]]*/

    // Funci√≥n para manejar mensajes de saldo
    function mostrarMensajeSaldo(mensaje, tipo) {
        const mensajeSaldo = document.getElementById('mensaje-saldo');
        if (!mensajeSaldo) return;

        mensajeSaldo.textContent = mensaje;
        mensajeSaldo.style.display = 'block';

        if (tipo === 'success') {
            mensajeSaldo.style.background = 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
            mensajeSaldo.style.color = '#2e7d32';
            mensajeSaldo.style.borderLeft = '3px solid #4caf50';
        } else {
            mensajeSaldo.style.background = 'linear-gradient(135deg, #ffebee, #ffcdd2)';
            mensajeSaldo.style.color = '#c62828';
            mensajeSaldo.style.borderLeft = '3px solid #f44336';
        }
    }

    // Configurar formulario de saldo
    function configurarFormularioSaldo() {
        console.log('‚öôÔ∏è Configurando formulario de saldo...');
        const formSaldo = document.getElementById('form-agregar-saldo');
        const inputCantidad = document.getElementById('input-cantidad-saldo');
        const btnAgregar = document.getElementById('btn-agregar-saldo');

        if (!formSaldo) {
            console.warn('‚ö†Ô∏è Formulario de saldo no encontrado');
            return;
        }

        formSaldo.addEventListener('submit', async (e) => {
            e.preventDefault();

            const cantidad = parseFloat(inputCantidad.value);

            if (!cantidad || cantidad <= 0 || cantidad > 1000) {
                mostrarMensajeSaldo('La cantidad debe estar entre 1‚Ç¨ y 1000‚Ç¨', 'error');
                return;
            }

            btnAgregar.disabled = true;
            btnAgregar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

            try {
                const response = await fetch('/cuenta/agregar-saldo-ajax', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `cantidad=${cantidad}`
                });

                const data = await response.json();

                if (data.success) {
                    mostrarMensajeSaldo(data.mensaje || 'Saldo agregado correctamente', 'success');
                    inputCantidad.value = '';

                    setTimeout(() => {
                        const msg = document.getElementById('mensaje-saldo');
                        if (msg) msg.style.display = 'none';
                    }, 3000);
                } else {
                    mostrarMensajeSaldo(data.error || 'Error al agregar saldo', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensajeSaldo('Error de conexi√≥n. Int√©ntalo de nuevo.', 'error');
            } finally {
                btnAgregar.disabled = false;
                btnAgregar.innerHTML = '<i class="fas fa-plus"></i> A√±adir';
            }
        });

        console.log('‚úÖ Formulario de saldo configurado');
    }
</script>

<!-- Script de prueba para diagnosticar carga -->
<script src="/js/test-load.js?v=3"
        onerror="console.error('‚ùå Ni siquiera se puede cargar test-load.js - problema con archivos est√°ticos');"
        onload="console.log('‚úÖ test-load.js cargado - archivos est√°ticos funcionan');"></script>

<!-- Cargar el script del estadio -->
<script src="/js/estadio-canvas.js?v=3"
        onerror="console.error('‚ùå ERROR: No se pudo cargar estadio-canvas.js'); document.getElementById('loading').innerHTML = '<div style=\'color:white;padding:40px;text-align:center;\'><h3>Error: No se pudo cargar el script</h3><p>Verifica que el servidor est√© corriendo</p><button onclick=\'location.reload()\' style=\'background:#ffd700;color:#1a237e;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;margin:10px;\'>Reintentar</button></div>';"
        onload="console.log('‚úÖ Script estadio-canvas.js cargado correctamente');"></script>

<!-- Inicializar cuando TODO est√© listo -->
<script>
    // Verificar inmediatamente si el script se carg√≥
    console.log('üîç Verificando carga del script...');
    console.log('window.initEstadio3D tipo:', typeof window.initEstadio3D);

    window.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ DOM cargado - Inicializando aplicaci√≥n');
        console.log('üìç Evento ID:', eventoId);
        console.log('üîç Verificando funciones globales:');
        console.log('  - initEstadio3D:', typeof initEstadio3D);
        console.log('  - resetearVista:', typeof resetearVista);
        console.log('  - confirmarCompra:', typeof confirmarCompra);

        // 1. Configurar formulario de saldo
        try {
            configurarFormularioSaldo();
        } catch (error) {
            console.error('‚ùå Error configurando formulario:', error);
        }

        // 2. Inicializar estadio con un peque√±o delay para asegurar que el script se carg√≥
        setTimeout(() => {
            if (typeof initEstadio3D === 'function') {
                console.log('üéÆ Funci√≥n initEstadio3D encontrada, iniciando...');
                try {
                    initEstadio3D(eventoId);
                } catch (error) {
                    console.error('‚ùå Error al inicializar estadio:', error);
                    console.error('Stack:', error.stack);
                }
            } else {
                console.error('‚ùå ERROR: initEstadio3D no est√° definida despu√©s del DOMContentLoaded');
                console.error('Tipo actual:', typeof initEstadio3D);
                console.error('window.initEstadio3D:', typeof window.initEstadio3D);

                // Mostrar error al usuario
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.innerHTML = `
                        <div style="color: white; text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #FFC107;"></i>
                            <h3>Error al cargar el estadio</h3>
                            <p>No se pudo cargar el visualizador 3D</p>
                            <p style="font-size: 0.9rem; color: #ffcdd2;">El script estadio-canvas.js no est√° disponible</p>
                            <details style="margin: 20px; text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                                <summary style="cursor: pointer; color: #ffd700;">Informaci√≥n t√©cnica</summary>
                                <pre style="color: #fff; font-size: 12px;">
Tipo de initEstadio3D: ${typeof initEstadio3D}
window.initEstadio3D: ${typeof window.initEstadio3D}
Script URL: /js/estadio-canvas.js?v=2

Posibles causas:
1. El servidor no est√° sirviendo archivos est√°ticos correctamente
2. Error de sintaxis en estadio-canvas.js
3. Problema de cach√© del navegador

Soluci√≥n:
1. Abre DevTools (F12) ‚Üí Console
2. Busca errores en rojo
3. Abre DevTools ‚Üí Network
4. Recarga y busca estadio-canvas.js
5. Verifica si aparece en rojo (error 404 o 500)
                                </pre>
                            </details>
                            <button onclick="location.reload()" style="
                                background: #ffd700;
                                color: #1a237e;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                font-weight: 700;
                                cursor: pointer;
                                margin: 10px;
                            ">Reintentar</button>
                            <br><br>
                            <a href="/eventos" style="color: #ffd700; text-decoration: underline;">Volver a Eventos</a>
                        </div>
                    `;
                }
            }
        }, 100); // Delay de 100ms para asegurar que el script se proces√≥ completamente
    });
</script>

</body>
</html>